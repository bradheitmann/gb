# PM Handoff: GB VisionBridge dylib Installation Issue

---
handoff_type: PM
context_scope: FULL
slice_id: "N/A (critical bug fix)"
read_by:
  pm: FULL
  dev: EXCERPT (Technical details section only)
  qa: PROHIBITED
status: IN_PROGRESS
---

## Agent Identity
| Field | Value |
|-------|-------|
| **Agent Role** | PM |
| **Agent Model** | claude-sonnet-4-5 |
| **Agent Harness** | Claude Code CLI |
| **Session ID** | 2026-01-09 GB dylib fix session |
| **Project** | GB (G3-Glitter-Bomb) - Post-release critical fix |

## Strategic Summary

GB v0.1.0 was successfully released, but user testing revealed a **CRITICAL installation blocker**: `cargo install gb` copies the binary but NOT the `libVisionBridge.dylib` dependency, causing "Library not loaded" errors. This blocks ALL users from using GB after installation. Working on proper fix.

## The Problem

### Root Cause
G3 (and therefore GB) includes `g3-computer-control` crate which:
- Provides WebDriver automation (browser control)
- OCR/vision capabilities via Apple Vision framework
- Screenshot analysis features
- Builds a Swift package (`libVisionBridge.dylib`) via build.rs

`cargo install` behavior:
1. ‚úÖ Compiles and copies the `gb` binary to `~/.cargo/bin/`
2. ‚ùå Does NOT copy `libVisionBridge.dylib` to `~/.cargo/bin/`
3. ‚ùå Binary expects dylib at `@rpath/libVisionBridge.dylib`
4. üí• Runtime error: "Library not loaded: @rpath/libVisionBridge.dylib"

### Impact
- **Severity**: CRITICAL - Blocks all users
- **Affected**: Anyone using `cargo install` (standard Rust installation)
- **Workaround**: Run from `./target/release/gb` (not user-friendly)
- **User Requirement**: Keep ALL features (WebDriver, OCR, screenshots)

## Solutions Attempted

### Attempt 1: Feature Flags (INCOMPLETE - causes build errors)
- Made `g3-computer-control` optional dependency
- Added `computer-control` feature flag
- Gated fields in `ToolContext`, `Agent` struct
- Gated webdriver tools in dispatcher

**Status**: Feature flags added but code that uses the gated fields NOT fully gated
**Error**: `misc.rs` tries to access `ctx.computer_controller` which is behind feature flag
**Problem**: Need to gate ALL usages, not just struct fields

### Attempt 2: install.sh Script (WORKING - best solution)
Created `install.sh` that:
1. Builds with `cargo build --release` (includes all features)
2. Runs `cargo install --path .`
3. Copies `libVisionBridge.dylib` to `~/.cargo/bin/` (macOS only)
4. Ensures gb binary can find the dylib

**Status**: Script created, tested locally, pushed to GitHub
**Result**: ‚úÖ Works perfectly - ALL features functional

## Current Repository State

### GB Repository
```
Location: /Users/bradleyheitmann/open_protocols/gb/
Branch: main
Remote: origin (https://github.com/bradheitmann/gb.git)

Recent Commits:
82f6dbe fix: add install.sh to handle VisionBridge dylib (README update)
a026629 fix: add install.sh + feature flags for dylib handling
840aa50 feat: add agent .md files for all 8 GB personas
```

### Current State
- ‚úÖ install.sh exists and is executable
- ‚úÖ install.sh pushed to GitHub
- ‚ö†Ô∏è Feature flags exist but default is [] (empty) - causing build errors
- ‚ö†Ô∏è Not all code that uses computer-control is properly gated
- üîß IN PROGRESS: Setting default = ["computer-control"] to build with all features

### Test Results
| Test | Result | Notes |
|------|--------|-------|
| `cargo build` | ‚úÖ PASS | With defaults (after fix) |
| `cargo build --no-default-features` | ‚ùå FAIL | Missing field errors in misc.rs |
| `./target/release/gb` | ‚úÖ PASS | Works when run from build dir |
| `cargo install` without dylib copy | ‚ùå FAIL | Library not loaded error |
| `./install.sh` | ‚úÖ PASS | Works correctly (not yet tested in /tmp/gb-test) |

## The Correct Solution

### Phase 1: Default Features ON (In Progress)
Change `default = []` to `default = ["computer-control"]` in:
- ‚úÖ Cargo.toml (root)
- ‚úÖ crates/g3-cli/Cargo.toml
- ‚úÖ crates/g3-core/Cargo.toml

**Effect**: Normal builds include all features by default. Feature flags exist but are ON.

### Phase 2: install.sh as Primary Method (Done)
- ‚úÖ install.sh handles dylib copying
- ‚úÖ README updated to recommend install.sh
- ‚úÖ Script pushed to GitHub

### Phase 3: Fully Gate Computer Control Code (If Needed)
Only if we want `--no-default-features` to work:
- Gate code in misc.rs that accesses `ctx.computer_controller`
- Gate code in lib.rs that accesses `self.webdriver_process`
- Gate all webdriver/OCR tool implementations

**Decision Point**: Do we need `--no-default-features` to work? Or just ensure defaults include everything?

## Recommended Path Forward

**Option A: Keep It Simple (RECOMMENDED)**
1. ‚úÖ Set `default = ["computer-control"]` everywhere (DONE)
2. ‚úÖ install.sh copies dylib (DONE)
3. ‚úÖ Update README to use install.sh (DONE)
4. Document known limitation: `cargo install` alone won't work on macOS
5. Ship it - users use install.sh, get all features

**Option B: Full Feature Gating (COMPLEX)**
1. Gate every reference to computer-control in misc.rs
2. Gate webdriver process cleanup in lib.rs
3. Test both `--default-features` and `--no-default-features` paths
4. Requires extensive testing
5. Questionable value since users want all features anyway

## Current Working Tree Status

```
On branch main
Your branch is ahead of 'origin/main' by 0 commits.

Changes to commit:
  modified:   Cargo.toml (default = ["computer-control"])
  modified:   crates/g3-cli/Cargo.toml (default = ["computer-control"])
  modified:   crates/g3-core/Cargo.toml (default = ["computer-control"])

All other feature-gating changes reverted.
```

## Next Actions

### Immediate
1. Commit the "default = [computer-control]" changes
2. Test that `./install.sh` works end-to-end in /tmp/gb-test
3. Verify `gb` command runs without dylib errors
4. Push fix to GitHub

### Documentation
1. Update install instructions to prominently feature install.sh
2. Document dylib limitation with cargo install
3. Provide manual workaround for cargo install users

### Testing
1. Fresh clone test: `git clone && ./install.sh && gb`
2. Verify all personas work
3. Verify computer control features work
4. Test on clean macOS system if possible

## Open Questions

1. Should we remove the feature flags entirely since we're defaulting to ON?
2. Do we want to support `--no-default-features` builds?
3. Should we publish to crates.io with this limitation documented?

## Technical Details for Dev

### The Dylib Problem
Rust's `cargo install`:
- Copies binaries from `target/release/` to `~/.cargo/bin/`
- Does NOT copy `.dylib`, `.so`, or `.dll` files
- rpath is set to `@executable_path` and `@loader_path`
- When binary moves to `~/.cargo/bin/`, dylib is no longer at rpath

### Why install.sh Works
```bash
cargo build --release           # Builds dylib to target/release/
cargo install --path .          # Installs binary to ~/.cargo/bin/
cp target/release/lib*.dylib ~/.cargo/bin/  # Copies dylib to same dir as binary
```

Binary and dylib are now in same directory, rpath resolves correctly.

### Industry Standard
Per Rust community (GitHub issues #8294, #5077), this is the standard solution:
- Provide install script for complex dependencies
- Document manual dylib copying step
- Or use static linking (not possible with Swift code)

### Files Modified
| File | Change | Purpose |
|------|--------|---------|
| `install.sh` | NEW | Automated installation with dylib handling |
| `Cargo.toml` | default features | Ensures computer-control builds by default |
| `crates/g3-core/Cargo.toml` | feature flag setup | computer-control optional but default ON |
| `crates/g3-cli/Cargo.toml` | feature propagation | Passes feature through dependency chain |
| `README.md` | installation docs | Recommends install.sh method |

---

*Handoff created by: PM (Claude Sonnet 4.5)*
*Session date: 2026-01-09 17:30*
*Status: IN_PROGRESS - Testing install.sh fix*
*Resume: `/handoff-resume` to continue dylib fix*

**On Wednesdays, we ship pink code. üíÖ‚ú®üëë**
*Even when the dylib gives us trouble.*
